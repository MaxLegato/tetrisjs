"use strict";function inArray(t,e){for(var r=e.length,a=0;r>a;a++)if(e[a]==t)return!0;return!1}function cloneObject(t){return $.extend(!0,{},t)}function debug(t,e){$("#output1 code").empty();var r="";r+='<div id="code-box-1" class="code-box">',r+="<p>myBlock.type: "+t.type+"<br />",r+="myBlock.currentState: "+t.currentState+"<br />",r+="myBlock.currentMatrix: "+t.currentMatrix.toString()+"<br />",r+="myBlock.currentIndex: "+t.currentIndex+"</p>",r+="<p>myBlock.state_1_startIndex: "+t.state_1_startIndex+"<br />",r+="myBlock.state_2_startIndex: "+t.state_2_startIndex+"<br />",r+="myBlock.state_3_startIndex: "+t.state_3_startIndex+"<br />",r+="myBlock.state_4_startIndex: "+t.state_4_startIndex+"</p>",r+="<p>myBlock.width: "+t.width+"<br />",r+="myBlock.height: "+t.height+"</p>",r+="</div>",$("#output1 code").append(r),r=null}function setGameOver(t,e,r){GAME_OVER=!0,GAME_RUNNING=!1,NEW_GAME=!1,clearInterval(r);for(var a=0;BOARD_ROWS>a;a++)for(var n=0;BOARD_COLS>n;n++)0!=e[a][n]&&(e[a][n]="x");return a=0,n=0,drawBoard(e),t=null,e=null,$("#myBoard-info").html("GAME OVER"),$("#myBoard-info").show(),$("#info-start-pause").html("Press <strong>F5</strong> to start over"),$("#thescore").append("<br />GAME OVER!"),r}function getTileImage(t){var e;switch(t){case"i":e="TILE_ORANGE.png";break;case"j":e="TILE_TEAL.png";break;case"l":e="TILE_BLUE.png";break;case"o":e="TILE_YELLOW.png";break;case"s":e="TILE_PURPLE.png";break;case"t":e="TILE_RED.png";break;case"z":e="TILE_GREEN.png";break;default:e="TILE.png"}return e}function drawBoardMatrix(t){$("#output2 code").empty();var e="";e+="<p>Current myBoard</p>",e+="<table>";for(var r=0;BOARD_ROWS>r;r++){e+="<tr>";for(var a=0;BOARD_COLS>a;a++)e+="<td>",e+=t[r][a],e+="</td>";e+="</tr>"}e+="</table>",$("#output2 code").append(e),e=null,r=null,a=null}function updateScore(t,e){switch(e){case 1:t+=10;break;case 2:t+=20;break;case 3:t+=30;break;case 4:t+=50}return t}function groundBlock(t){var e,r;for(e=0;e<t.height;e++)for(r=0;r<t.width;r++)0!=t.currentMatrix[e][r]&&(t.currentMatrix[e][r]=t.type);return t}function removeLines(t,e){var r,a=[0,0,0,0,0,0,0,0,0,0],n=[],s=[];for(r=0;BOARD_ROWS>r;r++)0==inArray(r,e)?(n=t[r].slice(),s.push(n)):s.unshift(a);return n=[],t=[],s=cloneObject(s)}function checkLines(t,e){var r,a,n=0;for(r=0;BOARD_ROWS>r;r++){for(a=0;BOARD_COLS>a;a++)0!=t[r][a]&&n++,n==BOARD_COLS&&0==inArray(r,e)&&e.push(r);n=0}return e}function checkCollisionBlock(t,e){for(var r=t.width,a=t.height,n=t.currentIndex,s=t.currentMatrix,_=n[0],c=n[1],i=0;a>i;i++){for(var d=0;r>d;d++){if(1==s[i][d]&&0!=e[_][c])return!0;c++}c=n[1],_++}return!1}function checkCollisionBoard(t,e){if(t.currentIndex[0]<0||t.currentIndex[0]>BOARD_ROWS-t.height||t.currentIndex[1]<0||t.currentIndex[1]>BOARD_COLS-t.width){switch(t.currentState=e,e){case 1:t.currentIndex=t.state_1_startIndex,t.currentMatrix=t.state_1_matrix;break;case 2:t.currentIndex=t.state_2_startIndex,t.currentMatrix=t.state_2_matrix;break;case 3:t.currentIndex=t.state_3_startIndex,t.currentMatrix=t.state_3_matrix;break;case 4:t.currentIndex=t.state_4_startIndex,t.currentMatrix=t.state_4_matrix}t.width=t.currentMatrix[0].length,t.height=t.currentMatrix.length}return t}function rotateBlock(t,e,r,a){r=wipeBoard(e,r);var n=e.currentState;switch(t){case"left":e.currentState--;break;case"right":e.currentState++}switch(5==e.currentState&&(e.currentState=1),0==e.currentState&&(e.currentState=4),e.currentState){case 1:e.currentIndex=e.state_1_startIndex,e.currentMatrix=e.state_1_matrix;break;case 2:e.currentIndex=e.state_2_startIndex,e.currentMatrix=e.state_2_matrix;break;case 3:e.currentIndex=e.state_3_startIndex,e.currentMatrix=e.state_3_matrix;break;case 4:e.currentIndex=e.state_4_startIndex,e.currentMatrix=e.state_4_matrix}return e.width=e.currentMatrix[0].length,e.height=e.currentMatrix.length,e=checkCollisionBoard(e,n)}function moveBlock(t,e,r,a){switch(r=wipeBoard(e,r),t){case"down":e.state_1_startIndex[0]++,e.state_2_startIndex[0]++,e.state_3_startIndex[0]++,e.state_4_startIndex[0]++,(e.currentIndex[0]>BOARD_ROWS-e.height||checkCollisionBlock(e,r))&&(e.state_1_startIndex[0]--,e.state_2_startIndex[0]--,e.state_3_startIndex[0]--,e.state_4_startIndex[0]--,e=groundBlock(e),e.currentState=0);break;case"left":e.state_1_startIndex[1]--,e.state_2_startIndex[1]--,e.state_3_startIndex[1]--,e.state_4_startIndex[1]--,(e.currentIndex[1]<0||checkCollisionBlock(e,r))&&(e.state_1_startIndex[1]++,e.state_2_startIndex[1]++,e.state_3_startIndex[1]++,e.state_4_startIndex[1]++);break;case"right":e.state_1_startIndex[1]++,e.state_2_startIndex[1]++,e.state_3_startIndex[1]++,e.state_4_startIndex[1]++,(e.currentIndex[1]>BOARD_COLS-e.width||checkCollisionBlock(e,r))&&(e.state_1_startIndex[1]--,e.state_2_startIndex[1]--,e.state_3_startIndex[1]--,e.state_4_startIndex[1]--)}return e}function drawBoard(t){for(var e,r,a,n,s,_=0;BOARD_ROWS>_;_++)for(var c=0;BOARD_COLS>c;c++)0!=t[_][c]&&1!=t[_][c]&&(e=t[_][c],a=getTileImage(e),r=document.createElement("IMG"),r.setAttribute("class","tile"),r.setAttribute("src",a),r.setAttribute("width","30"),r.setAttribute("width","30"),n=30*c,s=30*_,r.setAttribute("style","left: "+n+"px; top: "+s+"px;"),$("#myBoard").append(r),e=null,r=null,a=null,n=null,s=null);_=null,c=null}function drawBlock(t,e){for(var r,a,n,s=t.tileImage,_=0;BOARD_ROWS>_;_++)for(var c=0;BOARD_COLS>c;c++)1==e[_][c]&&(r=document.createElement("IMG"),r.setAttribute("class","tile"),r.setAttribute("src",s),r.setAttribute("width","30"),r.setAttribute("width","30"),a=30*c,n=30*_,r.setAttribute("style","left: "+a+"px; top: "+n+"px;"),$("#myBoard").append(r),r=null,a=null,n=null);_=null,c=null}function updateBoard(t,e){var r=e.width,a=e.height,n=0,s=0,_=0,c=0;for(n=e.currentIndex[0];n<a+e.currentIndex[0];n++){for(s=e.currentIndex[1];s<r+e.currentIndex[1];s++)0==t[n][s]&&(t[n][s]=e.currentMatrix[_][c]),c++;_++,c=0}return r=0,a=0,n=0,s=0,_=0,c=0,t}function wipeBoard(t,e){var r,a,n=t.currentIndex[0],s=t.currentIndex[1],_=t.width,c=t.height,i=0,d=0;for(r=n;c+n>r;r++){for(a=s;_+s>a;a++)1==e[r][a]&&(e[r][a]=0),d++;i++,d=0}return n=null,s=null,_=null,c=null,r=null,a=null,i=null,d=null,$(".tile").remove(),e}function update(t,e){drawBlock(t,e),drawBoard(e),drawBoardMatrix(e)}function initBlock(){var t={type:"",tileImage:"",currentState:0,currentMatrix:[[]],currentIndex:[[]],state_1_matrix:[[]],state_1_startIndex:[[]],state_2_matrix:[[]],state_2_startIndex:[[]],state_3_matrix:[[]],state_3_startIndex:[[]],state_4_matrix:[[]],state_4_startIndex:[[]],width:0,height:0},e=["i","j","l","o","s","t","z"],r=Math.floor(Math.random()*e.length),a=Math.floor(4*Math.random())+1,n=e[r];switch(t.type=n,t.currentState=a,n){case"i":t.tileImage="TILE_ORANGE.png",t.state_1_matrix=[[1],[1],[1],[1],[1]],t.state_2_matrix=[[1,1,1,1,1]],t.state_3_matrix=[[1],[1],[1],[1],[1]],t.state_4_matrix=[[1,1,1,1,1]],t.state_1_startIndex=[0,4],t.state_2_startIndex=[1,3],t.state_3_startIndex=[0,5],t.state_4_startIndex=[2,3];break;case"j":t.tileImage="TILE_TEAL.png",t.state_1_matrix=[[0,1],[0,1],[1,1]],t.state_2_matrix=[[1,0,0],[1,1,1]],t.state_3_matrix=[[1,1],[1,0],[1,0]],t.state_4_matrix=[[1,1,1],[0,0,1]],t.state_1_startIndex=[0,3],t.state_2_startIndex=[0,3],t.state_3_startIndex=[0,4],t.state_4_startIndex=[1,3];break;case"l":t.tileImage="TILE_BLUE.png",t.state_1_matrix=[[1,0],[1,0],[1,1]],t.state_2_matrix=[[1,1,1],[1,0,0]],t.state_3_matrix=[[1,1],[0,1],[0,1]],t.state_4_matrix=[[0,0,1],[1,1,1]],t.state_1_startIndex=[0,3],t.state_2_startIndex=[0,3],t.state_3_startIndex=[0,3],t.state_4_startIndex=[0,3];break;case"o":t.tileImage="TILE_YELLOW.png",t.state_1_matrix=[[1,1],[1,1]],t.state_2_matrix=[[1,1],[1,1]],t.state_3_matrix=[[1,1],[1,1]],t.state_4_matrix=[[1,1],[1,1]],t.state_1_startIndex=[0,4],t.state_2_startIndex=[0,4],t.state_3_startIndex=[0,4],t.state_4_startIndex=[0,4];break;case"s":t.tileImage="TILE_PURPLE.png",t.state_1_matrix=[[0,1,1],[1,1,0]],t.state_2_matrix=[[1,0],[1,1],[0,1]],t.state_3_matrix=[[0,1,1],[1,1,0]],t.state_4_matrix=[[1,0],[1,1],[0,1]],t.state_1_startIndex=[1,3],t.state_2_startIndex=[0,4],t.state_3_startIndex=[1,3],t.state_4_startIndex=[0,4];break;case"t":t.tileImage="TILE_RED.png",t.state_1_matrix=[[1,1,1],[0,1,0]],t.state_2_matrix=[[0,1],[1,1],[0,1]],t.state_3_matrix=[[0,1,0],[1,1,1]],t.state_4_matrix=[[1,0],[1,1],[1,0]],t.state_1_startIndex=[1,3],t.state_2_startIndex=[0,3],t.state_3_startIndex=[0,3],t.state_4_startIndex=[0,4];break;case"z":t.tileImage="TILE_GREEN.png",t.state_1_matrix=[[1,1,0],[0,1,1]],t.state_2_matrix=[[0,1],[1,1],[1,0]],t.state_3_matrix=[[1,1,0],[0,1,1]],t.state_4_matrix=[[0,1],[1,1],[1,0]],t.state_1_startIndex=[1,3],t.state_2_startIndex=[0,4],t.state_3_startIndex=[1,3],t.state_4_startIndex=[0,4]}switch(a){case 1:t.currentMatrix=t.state_1_matrix,t.currentIndex=t.state_1_startIndex;break;case 2:t.currentMatrix=t.state_2_matrix,t.currentIndex=t.state_2_startIndex;break;case 3:t.currentMatrix=t.state_3_matrix,t.currentIndex=t.state_3_startIndex;break;case 4:t.currentMatrix=t.state_4_matrix,t.currentIndex=t.state_4_startIndex}return t.width=t.currentMatrix[0].length,t.height=t.currentMatrix.length,e=null,r=null,a=null,n=null,t}function initLineStack(){var t=[];return t}function initBoard(){for(var t=[[]],e=0;BOARD_ROWS>e;e++){t[e]=new Array;for(var r=0;BOARD_COLS>r;r++)t[e][r]=0}return e=null,r=null,t}function checkGameOver(t,e){var r=t.width,a=t.height,n=0,s=0,_=0,c=0;for(n=t.currentIndex[0];n<a+t.currentIndex[0];n++){for(s=t.currentIndex[1];s<r+t.currentIndex[1];s++){try{if(0!=e[n][s]&&1==t[_][c])return!0}catch(i){return!0}c++}_++,c=0}return r=0,a=0,n=0,s=0,_=0,c=0,!1}var BOARD_WIDTH=420,BOARD_HEIGHT=690,TILE_WIDTH=30,TILE_HEIGHT=30,BOARD_ROWS=20,BOARD_COLS=10,SCORE_1_LINE=10,SCORE_2_LINE=20,SCORE_3_LINE=30,SCORE_4_LINE=50,NEW_GAME=!1,GAME_RUNNING=!1,GAME_OVER=!1;$(document).ready(function(){var t,e,r,a=0,n=setInterval(function(){if(NEW_GAME&&GAME_RUNNING){var t=$.Event("keydown");t.keyCode=40,t.which=65,$("body").trigger(t)}},800);$("body").keydown(function(s){if(13==s.keyCode&&0==GAME_OVER&&(0==NEW_GAME?(t=initBlock(),e=initBoard(),r=initLineStack(),e=updateBoard(e,t),update(t,e),NEW_GAME=!0,GAME_RUNNING=!0,$("#myBoard-info").hide(),$("#info-start-pause").html("<code>Press <strong>ENTER</strong> to pause game</code>")):GAME_RUNNING?(GAME_RUNNING=!1,$("#myBoard-info").html("GAME PAUSED"),$("#myBoard-info").show(),$("#info-start-pause").html("<code>Press <strong>ENTER</strong> to resume game</code>")):(GAME_RUNNING=!0,$("#myBoard-info").html("GAME PAUSED"),$("#myBoard-info").hide(),$("#info-start-pause").html("<code>Press <strong>ENTER</strong> to pause game</code>"))),80==s.keyCode&&(GAME_RUNNING?(GAME_RUNNING=!1,$("#myBoard-info").html("GAME PAUSED"),$("#myBoard-info").show()):(GAME_RUNNING=!0,$("#myBoard-info").hide())),GAME_RUNNING){switch(s.keyCode){case 37:t=moveBlock("left",t,e,r),e=updateBoard(e,t);break;case 40:t=moveBlock("down",t,e,r),0==t.currentState&&(e=updateBoard(e,t),r=checkLines(e,r),r.length>0&&(r.sort(),e=removeLines(e,r),a=updateScore(a,r.length),$("#thescore > span").text(a),r=[]),t=null,t=initBlock(t),checkGameOver(t,e)&&(n=setGameOver(t,e,n))),e=updateBoard(e,t),update(t,e);break;case 39:t=moveBlock("right",t,e,r),e=updateBoard(e,t);break;case 65:t=rotateBlock("left",t,e,r),e=updateBoard(e,t);break;case 68:t=rotateBlock("right",t,e,r),e=updateBoard(e,t);break;case 32:for(;t.currentState>0;)t=moveBlock("down",t,e,r);0==t.currentState&&(e=updateBoard(e,t),r=checkLines(e,r),r.length>0&&(r.sort(),e=removeLines(e,r),a=updateScore(a,r.length),$("#thescore > span").text(a),r=[]),t=null,t=initBlock(t),checkGameOver(t,e)&&(n=setGameOver(t,e,n))),e=updateBoard(e,t),update(t,e)}update(t,e)}})});